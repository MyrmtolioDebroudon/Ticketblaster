<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Details - TicketBlaster</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8f9fa;
        }

        .navbar {
            background: var(--primary-gradient);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .event-hero {
            background: var(--primary-gradient);
            color: white;
            padding: 3rem 0;
            margin-bottom: 3rem;
        }

        .event-image {
            width: 100%;
            height: 400px;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8rem;
            margin-bottom: 2rem;
        }

        .event-info-card {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .event-meta {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
            padding: 0.5rem 0;
            border-bottom: 1px solid #e9ecef;
        }

        .event-meta:last-child {
            border-bottom: none;
        }

        .event-meta i {
            width: 30px;
            text-align: center;
            color: #667eea;
            margin-right: 1rem;
        }

        .ticket-selection {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .ticket-type {
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .ticket-type:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .ticket-type.selected {
            border-color: #667eea;
            background: #f8f9ff;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
        }

        .ticket-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .ticket-name {
            font-size: 1.2rem;
            font-weight: 600;
            color: #333;
        }

        .ticket-price {
            font-size: 1.5rem;
            font-weight: 700;
            color: #e74c3c;
        }

        .ticket-quantity {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-top: 1rem;
        }

        .quantity-control {
            display: flex;
            align-items: center;
            border: 1px solid #ddd;
            border-radius: 5px;
            overflow: hidden;
        }

        .quantity-control button {
            background: #f8f9fa;
            border: none;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .quantity-control button:hover {
            background: #e9ecef;
        }

        .quantity-control input {
            width: 60px;
            text-align: center;
            border: none;
            padding: 0.5rem;
            background: white;
        }

        .total-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 1.5rem;
            margin-top: 2rem;
        }

        .total-line {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .total-line.final {
            font-size: 1.2rem;
            font-weight: 700;
            border-top: 2px solid #dee2e6;
            padding-top: 1rem;
            margin-top: 1rem;
        }

        .btn-purchase {
            background: var(--secondary-gradient);
            border: none;
            border-radius: 25px;
            padding: 1rem 2rem;
            font-size: 1.1rem;
            font-weight: 600;
            color: white;
            width: 100%;
            transition: all 0.3s ease;
        }

        .btn-purchase:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            color: white;
        }

        .btn-purchase:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .event-description {
            line-height: 1.8;
            color: #555;
        }

        .venue-map {
            background: #e9ecef;
            height: 300px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            font-size: 1.1rem;
        }

        .alert-custom {
            border: none;
            border-radius: 10px;
            padding: 1rem 1.5rem;
        }

        .social-share {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }

        .social-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            color: white;
            font-size: 1.2rem;
            transition: all 0.3s ease;
        }

        .social-btn:hover {
            transform: translateY(-2px);
            color: white;
        }

        .social-facebook { background: #3b5998; }
        .social-twitter { background: #1da1f2; }
        .social-instagram { background: #e1306c; }
        .social-whatsapp { background: #25d366; }

        .organizer-info {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 1.5rem;
            margin-top: 2rem;
        }

        .organizer-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--primary-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            margin-right: 1rem;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loading-spinner {
            background: white;
            border-radius: 10px;
            padding: 2rem;
            text-align: center;
        }

        @media (max-width: 768px) {
            .event-image {
                height: 250px;
                font-size: 4rem;
            }
            
            .ticket-header {
                flex-direction: column;
                align-items: flex-start;
            }
        }

        /* Real-time update styles */
        .purchase-notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--secondary-gradient);
            color: white;
            padding: 1rem 2rem;
            border-radius: 10px;
            font-size: 1.2rem;
            font-weight: 600;
            z-index: 9999;
            animation: purchaseAnimation 3s ease-in-out;
        }

        @keyframes purchaseAnimation {
            0% { 
                transform: translate(-50%, -50%) scale(0.5);
                opacity: 0;
            }
            20% { 
                transform: translate(-50%, -50%) scale(1.1);
                opacity: 1;
            }
            80% { 
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
            100% { 
                transform: translate(-50%, -50%) scale(0.8);
                opacity: 0;
            }
        }

        .sold-out {
            opacity: 0.6;
            pointer-events: none;
        }

        .sold-out::after {
            content: "SOLD OUT";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(220, 53, 69, 0.9);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            font-weight: bold;
            font-size: 1.1rem;
        }

        .quantity-updated {
            animation: quantityPulse 0.5s ease-in-out;
            color: #28a745 !important;
        }

        .price-updated {
            animation: pricePulse 0.5s ease-in-out;
            color: #007bff !important;
        }

        @keyframes quantityPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); background: #d4edda; }
            100% { transform: scale(1); }
        }

        @keyframes pricePulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); background: #d1ecf1; }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading event details...</p>
        </div>
    </div>

    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="/main-homepage.html">
                <i class="fas fa-ticket-alt me-2"></i>TicketBlaster
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/events.html">Browse Events</a>
                <a class="nav-link" href="/dashboard.html">Dashboard</a>
                <a class="nav-link" href="/main-homepage.html">Home</a>
            </div>
        </div>
    </nav>

    <div class="event-hero">
        <div class="container">
            <div class="row">
                <div class="col-lg-6">
                    <div class="event-image">
                        <i class="fas fa-calendar-alt"></i>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="event-info-card">
                        <h1 id="eventTitle">Loading...</h1>
                        <div class="event-meta">
                            <i class="fas fa-calendar-alt"></i>
                            <div>
                                <strong>Date & Time</strong>
                                <div id="eventDateTime" class="text-muted">Loading...</div>
                            </div>
                        </div>
                        <div class="event-meta">
                            <i class="fas fa-map-marker-alt"></i>
                            <div>
                                <strong>Venue</strong>
                                <div id="eventVenue" class="text-muted">Loading...</div>
                            </div>
                        </div>
                        <div class="event-meta">
                            <i class="fas fa-tag"></i>
                            <div>
                                <strong>Category</strong>
                                <div id="eventCategory" class="text-muted">Loading...</div>
                            </div>
                        </div>
                        <div class="event-meta">
                            <i class="fas fa-clock"></i>
                            <div>
                                <strong>Duration</strong>
                                <div id="eventDuration" class="text-muted">2 hours</div>
                            </div>
                        </div>
                        
                        <div class="social-share">
                            <a href="#" class="social-btn social-facebook" onclick="shareEvent('facebook')">
                                <i class="fab fa-facebook-f"></i>
                            </a>
                            <a href="#" class="social-btn social-twitter" onclick="shareEvent('twitter')">
                                <i class="fab fa-twitter"></i>
                            </a>
                            <a href="#" class="social-btn social-instagram" onclick="shareEvent('instagram')">
                                <i class="fab fa-instagram"></i>
                            </a>
                            <a href="#" class="social-btn social-whatsapp" onclick="shareEvent('whatsapp')">
                                <i class="fab fa-whatsapp"></i>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="row">
            <div class="col-lg-8">
                <!-- Event Description -->
                <div class="event-info-card">
                    <h3>About This Event</h3>
                    <div class="event-description" id="eventDescription">
                        Loading event description...
                    </div>
                </div>

                <!-- Venue Information -->
                <div class="event-info-card">
                    <h3>Venue Information</h3>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="venue-map">
                                <div class="text-center">
                                    <i class="fas fa-map fa-3x mb-3"></i>
                                    <p>Interactive venue map would be displayed here</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="venue-details">
                                <h5 id="venueName">Loading...</h5>
                                <p id="venueAddress" class="text-muted">Loading...</p>
                                <div class="venue-info">
                                    <p><strong>Capacity:</strong> <span id="venueCapacity">Loading...</span></p>
                                    <p><strong>Parking:</strong> Available on-site</p>
                                    <p><strong>Accessibility:</strong> Wheelchair accessible</p>
                                    <p><strong>Age Restriction:</strong> <span id="ageRestriction">All ages welcome</span></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Organizer Information -->
                <div class="organizer-info">
                    <h5>Event Organizer</h5>
                    <div class="d-flex align-items-center">
                        <div class="organizer-avatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <div>
                            <h6 id="organizerName">Loading...</h6>
                            <p class="text-muted mb-0">Professional event organizer</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <!-- Ticket Selection -->
                <div class="ticket-selection">
                    <h3>Select Tickets</h3>
                    <div id="ticketTypes">
                        <!-- Ticket types will be populated here -->
                    </div>
                    
                    <div class="total-section">
                        <div class="total-line">
                            <span>Subtotal:</span>
                            <span id="subtotal">$0.00</span>
                        </div>
                        <div class="total-line">
                            <span>Service Fee:</span>
                            <span id="serviceFee">$0.00</span>
                        </div>
                        <div class="total-line">
                            <span>Tax:</span>
                            <span id="tax">$0.00</span>
                        </div>
                        <div class="total-line final">
                            <span>Total:</span>
                            <span id="total">$0.00</span>
                        </div>
                    </div>
                    
                    <button class="btn btn-purchase" id="purchaseBtn" onclick="proceedToCheckout()" disabled>
                        <i class="fas fa-shopping-cart me-2"></i>
                        Add to Cart
                    </button>
                    
                    <div class="mt-3">
                        <small class="text-muted">
                            <i class="fas fa-shield-alt me-1"></i>
                            Secure checkout with 256-bit SSL encryption
                        </small>
                    </div>
                </div>

                <!-- Event Status -->
                <div class="event-info-card">
                    <h5>Event Status</h5>
                    <div class="alert alert-success alert-custom">
                        <i class="fas fa-check-circle me-2"></i>
                        <strong>Available:</strong> Tickets on sale now!
                    </div>
                    <div class="live-updates">
                        <small class="text-muted">
                            <i class="fas fa-wifi me-1"></i>
                            <span id="connection-status">Connecting...</span>
                        </small>
                    </div>
                    <div class="event-stats">
                        <div class="d-flex justify-content-between mb-2">
                            <span>Tickets Sold:</span>
                            <span id="ticketsSold">Loading...</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Tickets Remaining:</span>
                            <span id="ticketsRemaining">Loading...</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>Price Range:</span>
                            <span id="priceRange">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@microsoft/signalr@latest/dist/browser/signalr.min.js"></script>
    <script src="/js/signalr-client.js"></script>
    <script>
        // Global variables
        let currentEvent = null;
        let selectedTickets = {};
        let cartTotal = 0;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            const eventId = new URLSearchParams(window.location.search).get('id');
            if (eventId) {
                loadEventDetails(eventId);
                setupSignalRForEvent(eventId);
            } else {
                showError('No event ID provided');
            }
        });

        // Setup SignalR for real-time updates
        function setupSignalRForEvent(eventId) {
            // Wait for SignalR to be ready
            if (window.ticketBlasterSignalR) {
                // Join event group for real-time updates
                window.ticketBlasterSignalR.addEventListener('eventUpdated', (eventData) => {
                    if (eventData.EventId == eventId) {
                        currentEvent = eventData;
                        displayEventDetails();
                    }
                });

                window.ticketBlasterSignalR.addEventListener('ticketAvailabilityChanged', (data) => {
                    if (data.EventId == eventId) {
                        updateTicketAvailability(data.TicketTypeId, data.RemainingQuantity);
                    }
                });

                window.ticketBlasterSignalR.addEventListener('ticketPurchased', (data) => {
                    if (data.EventId == eventId) {
                        showPurchaseAnimation(data);
                    }
                });

                window.ticketBlasterSignalR.addEventListener('priceChanged', (data) => {
                    if (data.EventId == eventId) {
                        updateTicketPrice(data.TicketTypeId, data.NewPrice);
                    }
                });

                // Try to join event group
                setTimeout(() => {
                    if (window.ticketBlasterSignalR.isConnected) {
                        window.ticketBlasterSignalR.joinEventGroup(eventId);
                    }
                }, 1000);
            }
        }

        // Update ticket availability in real-time
        function updateTicketAvailability(ticketTypeId, remainingQuantity) {
            const availabilityElements = document.querySelectorAll(`[data-ticket-id="${ticketTypeId}"] .available-quantity`);
            availabilityElements.forEach(element => {
                element.textContent = `${remainingQuantity} available`;
                element.classList.add('quantity-updated');
                setTimeout(() => element.classList.remove('quantity-updated'), 2000);
            });

            // Update max quantity on inputs
            const quantityInput = document.getElementById(`qty-${ticketTypeId}`);
            if (quantityInput) {
                quantityInput.setAttribute('max', remainingQuantity);
                
                // Reset quantity if it exceeds available
                if (parseInt(quantityInput.value) > remainingQuantity) {
                    quantityInput.value = remainingQuantity;
                    changeQuantity(ticketTypeId, 0); // Recalculate total
                }
            }

            // Mark as sold out if no tickets left
            if (remainingQuantity === 0) {
                const ticketElement = document.querySelector(`[data-ticket-id="${ticketTypeId}"]`);
                if (ticketElement) {
                    ticketElement.classList.add('sold-out');
                    const buttons = ticketElement.querySelectorAll('button');
                    buttons.forEach(btn => btn.disabled = true);
                }
            }
        }

        // Update ticket price in real-time
        function updateTicketPrice(ticketTypeId, newPrice) {
            const priceElements = document.querySelectorAll(`[data-ticket-id="${ticketTypeId}"] .ticket-price`);
            priceElements.forEach(element => {
                element.textContent = `$${newPrice.toFixed(2)}`;
                element.classList.add('price-updated');
                setTimeout(() => element.classList.remove('price-updated'), 2000);
            });

            // Update ticket object if it exists
            if (currentEvent && currentEvent.ticketTypes) {
                const ticketType = currentEvent.ticketTypes.find(t => t.ticketTypeId === ticketTypeId);
                if (ticketType) {
                    ticketType.price = newPrice;
                    updateTotal(); // Recalculate total
                }
            }
        }

        // Show purchase animation
        function showPurchaseAnimation(data) {
            // Create floating animation
            const notification = document.createElement('div');
            notification.className = 'purchase-notification';
            notification.innerHTML = `
                <i class="fas fa-shopping-cart"></i>
                ${data.Quantity} ticket(s) purchased!
            `;
            document.body.appendChild(notification);

            // Remove after animation
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 3000);
        }

        // Load event details
        async function loadEventDetails(eventId) {
            showLoading(true);
            try {
                const response = await fetch(`/api/events/${eventId}`);
                if (response.ok) {
                    currentEvent = await response.json();
                    displayEventDetails();
                } else {
                    showError('Event not found');
                }
            } catch (error) {
                console.error('Error loading event:', error);
                showDemoEvent();
            } finally {
                showLoading(false);
            }
        }

        // Display event details
        function displayEventDetails() {
            if (!currentEvent) return;

            // Update basic event info
            document.getElementById('eventTitle').textContent = currentEvent.title;
            document.getElementById('eventDateTime').textContent = new Date(currentEvent.startDate).toLocaleString();
            document.getElementById('eventVenue').textContent = currentEvent.location;
            document.getElementById('eventCategory').textContent = currentEvent.category?.name || 'General';
            document.getElementById('eventDescription').textContent = currentEvent.description || 'No description available.';
            
            // Update venue details
            document.getElementById('venueName').textContent = currentEvent.location;
            document.getElementById('venueAddress').textContent = currentEvent.address || 'Address not provided';
            document.getElementById('venueCapacity').textContent = currentEvent.capacity || 'Not specified';
            
            // Update organizer info
            document.getElementById('organizerName').textContent = 'Event Organizer';
            
            // Display ticket types
            displayTicketTypes();
            
            // Update event statistics
            updateEventStats();
        }

        // Display ticket types
        function displayTicketTypes() {
            const container = document.getElementById('ticketTypes');
            
            if (!currentEvent.ticketTypes || currentEvent.ticketTypes.length === 0) {
                container.innerHTML = '<p class="text-muted">No tickets available</p>';
                return;
            }

            const ticketsHtml = currentEvent.ticketTypes.map(ticket => `
                <div class="ticket-type" data-ticket-id="${ticket.ticketTypeId}" onclick="selectTicketType(${ticket.ticketTypeId})">
                    <div class="ticket-header">
                        <div class="ticket-name">${ticket.name}</div>
                        <div class="ticket-price">$${ticket.price.toFixed(2)}</div>
                    </div>
                    <p class="text-muted mb-0">${ticket.description || 'Standard admission'}</p>
                    <div class="ticket-quantity">
                        <span>Quantity:</span>
                        <div class="quantity-control">
                            <button type="button" onclick="changeQuantity(${ticket.ticketTypeId}, -1)">-</button>
                            <input type="number" id="qty-${ticket.ticketTypeId}" value="0" min="0" max="${ticket.availableQuantity}" readonly>
                            <button type="button" onclick="changeQuantity(${ticket.ticketTypeId}, 1)">+</button>
                        </div>
                        <small class="text-muted">${ticket.availableQuantity} available</small>
                    </div>
                </div>
            `).join('');

            container.innerHTML = ticketsHtml;
        }

        // Show demo event
        function showDemoEvent() {
            const demoEvent = {
                eventId: 1,
                title: "Rock Concert 2024",
                startDate: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000),
                location: "Madison Square Garden",
                description: "Join us for an unforgettable night of rock music featuring top artists from around the world. This concert promises to be an amazing experience with great music, lighting, and atmosphere.",
                category: { name: "Music" },
                ticketTypes: [
                    {
                        ticketTypeId: 1,
                        name: "General Admission",
                        price: 89.99,
                        description: "Standing room access to the main floor",
                        availableQuantity: 500
                    },
                    {
                        ticketTypeId: 2,
                        name: "VIP Package",
                        price: 199.99,
                        description: "Premium seating with exclusive perks",
                        availableQuantity: 50
                    }
                ]
            };

            currentEvent = demoEvent;
            displayEventDetails();
        }

        // Select ticket type
        function selectTicketType(ticketId) {
            const ticketElement = document.querySelector(`[data-ticket-id="${ticketId}"]`);
            ticketElement.classList.add('selected');
        }

        // Change quantity
        function changeQuantity(ticketId, change) {
            const quantityInput = document.getElementById(`qty-${ticketId}`);
            const currentQuantity = parseInt(quantityInput.value);
            const newQuantity = Math.max(0, currentQuantity + change);
            
            // Get max available
            const ticket = currentEvent.ticketTypes.find(t => t.ticketTypeId === ticketId);
            const maxQuantity = ticket ? ticket.availableQuantity : 0;
            
            if (newQuantity <= maxQuantity) {
                quantityInput.value = newQuantity;
                selectedTickets[ticketId] = {
                    ticket: ticket,
                    quantity: newQuantity
                };
                
                updateTotal();
            }
        }

        // Update total
        function updateTotal() {
            let subtotal = 0;
            let totalQuantity = 0;
            
            Object.values(selectedTickets).forEach(item => {
                if (item.quantity > 0) {
                    subtotal += item.ticket.price * item.quantity;
                    totalQuantity += item.quantity;
                }
            });

            const serviceFee = subtotal * 0.10; // 10% service fee
            const tax = subtotal * 0.08; // 8% tax
            const total = subtotal + serviceFee + tax;

            document.getElementById('subtotal').textContent = `$${subtotal.toFixed(2)}`;
            document.getElementById('serviceFee').textContent = `$${serviceFee.toFixed(2)}`;
            document.getElementById('tax').textContent = `$${tax.toFixed(2)}`;
            document.getElementById('total').textContent = `$${total.toFixed(2)}`;

            cartTotal = total;
            
            // Enable/disable purchase button
            const purchaseBtn = document.getElementById('purchaseBtn');
            purchaseBtn.disabled = totalQuantity === 0;
        }

        // Update event statistics
        function updateEventStats() {
            const totalCapacity = currentEvent.ticketTypes?.reduce((sum, ticket) => sum + ticket.maxQuantity, 0) || 0;
            const totalSold = currentEvent.ticketTypes?.reduce((sum, ticket) => sum + ticket.soldQuantity, 0) || 0;
            const remaining = totalCapacity - totalSold;
            
            const minPrice = Math.min(...(currentEvent.ticketTypes?.map(t => t.price) || [0]));
            const maxPrice = Math.max(...(currentEvent.ticketTypes?.map(t => t.price) || [0]));
            
            document.getElementById('ticketsSold').textContent = totalSold;
            document.getElementById('ticketsRemaining').textContent = remaining;
            document.getElementById('priceRange').textContent = `$${minPrice.toFixed(2)} - $${maxPrice.toFixed(2)}`;
        }

        // Proceed to checkout
        function proceedToCheckout() {
            if (cartTotal === 0) {
                alert('Please select at least one ticket');
                return;
            }

            // Create order data
            const orderData = {
                eventId: currentEvent.eventId,
                tickets: selectedTickets,
                total: cartTotal
            };

            // Store in session storage for checkout
            sessionStorage.setItem('orderData', JSON.stringify(orderData));
            
            // Redirect to checkout or show login
            const token = localStorage.getItem('token');
            if (token) {
                window.location.href = '/checkout.html';
            } else {
                window.location.href = '/login.html?redirect=' + encodeURIComponent('/checkout.html');
            }
        }

        // Share event
        function shareEvent(platform) {
            const eventTitle = currentEvent?.title || 'Amazing Event';
            const eventUrl = window.location.href;
            
            const shareUrls = {
                facebook: `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(eventUrl)}`,
                twitter: `https://twitter.com/intent/tweet?text=${encodeURIComponent(eventTitle)}&url=${encodeURIComponent(eventUrl)}`,
                whatsapp: `https://wa.me/?text=${encodeURIComponent(eventTitle + ' ' + eventUrl)}`,
                instagram: '#' // Instagram doesn't support direct sharing
            };
            
            if (shareUrls[platform] !== '#') {
                window.open(shareUrls[platform], '_blank', 'width=600,height=400');
            } else {
                alert('Instagram sharing: Please copy the link and share manually!');
            }
        }

        // Show loading
        function showLoading(show) {
            document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
        }

        // Show error
        function showError(message) {
            const container = document.querySelector('.container');
            container.innerHTML = `
                <div class="text-center py-5">
                    <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                    <h3>Error</h3>
                    <p class="text-muted">${message}</p>
                    <a href="/events.html" class="btn btn-primary">Browse Events</a>
                </div>
            `;
        }
    </script>
</body>
</html>